# 🚕 打车测试客户端使用指南

## 📋 功能说明

已修改 `test/test_client.py`，实现自动打车状态机，方便测试打车功能。

---

## 🔄 状态转换逻辑

### **1. 默认状态**

- **导航状态**: `1` (正常行驶)
- **发送频率**: 每 0.5 秒（1秒2次）
- **持续时间**: 一直保持，直到收到 0x1003 协议

### **2. 收到打车订单（0x1003）**

当测试客户端收到 0x1003 协议（出租车订单）时，自动启动打车状态机：

```
默认状态 (导航状态=1)
    ↓
收到 0x1003 协议
    ↓
打车状态机启动
    ↓
3 (接客模式-去起点) ──5秒──→ 9 (到达接客起点) ──5秒──→ 4 (接客模式-去终点) ──5秒──→ 10 (到达接客终点) ──5秒──→ 回到 1 (正常行驶)
```

### **状态详细说明**

| 导航状态 | 含义 | 持续时间 | 说明 |
|---------|------|---------|------|
| **1** | 正常行驶 | 无限 | 默认状态，一直发送直到收到订单 |
| **3** | 接客模式-去起点 | 5秒 | 收到订单后立即切换 |
| **9** | 到达接客起点 | 5秒 | 自动切换 |
| **4** | 接客模式-去终点 | 5秒 | 自动切换 |
| **10** | 到达接客终点 | 5秒 | **只发一次**，然后回到状态1 |

---

## 🛠️ 代码实现

### **1. 全局状态机变量**

**位置**: `test/test_client.py:47-103`

```python
# 打车状态机全局变量
taxi_state_machine = {
    'active': False,              # 是否激活打车状态机
    'current_state': 1,           # 当前导航状态
    'state_start_time': 0,        # 当前状态开始时间（秒）
    'state_sequence': [3, 9, 4, 10],  # 打车状态序列
    'state_index': 0,             # 当前在序列中的索引
    'state_duration': 5           # 每个状态持续时间（秒）
}
```

### **2. 状态机管理函数**

#### `start_taxi_state_machine()`

**功能**: 启动打车状态机

```python
def start_taxi_state_machine():
    """启动打车状态机"""
    global taxi_state_machine
    taxi_state_machine['active'] = True
    taxi_state_machine['current_state'] = 3  # 第一个状态：去起点接客
    taxi_state_machine['state_start_time'] = time.time()
    taxi_state_machine['state_index'] = 0
    print(f"\n🚕 [打车状态机] 已启动，导航状态切换为: 3 (接客模式-去起点)")
```

#### `update_taxi_state_machine()`

**功能**: 更新打车状态机，自动切换状态

```python
def update_taxi_state_machine():
    """更新打车状态机（在每次发送车辆信息时调用）"""
    # 1. 如果状态机未激活，返回默认状态1
    # 2. 检查当前状态是否已经持续了5秒
    # 3. 如果是，切换到下一个状态
    # 4. 如果所有状态完成，回到状态1并停止状态机
```

### **3. 车辆信息协议修改**

**位置**: `test/test_client.py:605-614`

```python
# 导航状态 (1字节, UINT8) - 使用打车状态机
# 状态转换：1（默认）→ 收到0x1003后 → 3（5秒）→ 9（5秒）→ 4（5秒）→ 10（5秒）→ 回到1
now_ms = int(time.time() * 1000)
if now_ms < force_parallel_until:
    # 平行驾驶模式优先级最高
    nav_status = 15
else:
    # 使用打车状态机的状态
    nav_status = update_taxi_state_machine()
data.extend(struct.pack('<B', nav_status))
```

### **4. 接收打车订单处理**

**位置**: `test/test_client.py:866-881`

```python
elif message_type == SEND_MESSAGE_TYPES['TAXI_ORDER']:
    # 解析出租车订单指令
    taxi_info = parse_taxi_order_message(data_domain)
    if taxi_info:
        print(f"🚕 出租车订单:")
        print(f"   目标车辆: {taxi_info['vehicle_id']}")
        print(f"   起点: ({taxi_info['start_x']:.3f}, {taxi_info['start_y']:.3f})")
        print(f"   终点: ({taxi_info['end_x']:.3f}, {taxi_info['end_y']:.3f})")
        
        # 检查是否是当前车辆的订单
        if taxi_info['vehicle_id'] == self.vehicle_id:
            print(f"✅ 车辆{self.vehicle_id}收到出租车订单，启动打车状态机")
            # 启动打车状态机
            start_taxi_state_machine()
        else:
            print(f"ℹ️ 订单目标车辆({taxi_info['vehicle_id']})与当前车辆({self.vehicle_id})不匹配")
```

---

## 🧪 测试步骤

### **1. 启动测试客户端**

```bash
cd /Users/plum/Workspace/rust/dz-viz
python3 test/test_client.py 1  # 启动车辆ID=1的测试客户端
```

**预期输出**：

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🚗 车辆编号: 1
   📍 位置: X=...m, Y=...m
   🧭 朝向: ...rad (...°)
   🚀 车速: ...m/s | 🔋 电量: ...%
   ⚙️  档位: D1 | 🎯 方向盘: ...°
   🗺️  导航: 正常行驶(空载不入库)  ← 默认状态1
   📷 相机: 正常 | 📡 雷达: 正常 | 🔄 陀螺仪: 正常
   🅿️  车位占用: 未占用
   🛣️  路段: 1 | 进度: 25.00%
```

---

### **2. 在应用中打车**

1. 打开应用，进入"自动驾驶"菜单
2. 选择起点
3. 选择终点
4. 点击"呼叫出租车"

---

### **3. 观察测试客户端日志**

#### **收到打车订单**

```
🚕 出租车订单:
   目标车辆: 1
   起点: (1.234, 5.678)
   终点: (9.876, 5.432)
✅ 车辆1收到出租车订单，启动打车状态机

🚕 [打车状态机] 已启动，导航状态切换为: 3 (接客模式-去起点)
```

#### **状态3：去起点接客（5秒）**

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🚗 车辆编号: 1
   ...
   🗺️  导航: 接客模式-去起点  ← 状态3
   ...
```

#### **状态9：到达接客起点（5秒）**

```
🚕 [打车状态机] 导航状态切换为: 9 (到达接客起点)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🚗 车辆编号: 1
   ...
   🗺️  导航: 到达接客起点  ← 状态9
   ...
```

#### **状态4：去终点送客（5秒）**

```
🚕 [打车状态机] 导航状态切换为: 4 (接客模式-去终点)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🚗 车辆编号: 1
   ...
   🗺️  导航: 接客模式-去终点  ← 状态4
   ...
```

#### **状态10：到达接客终点（5秒，只发一次）**

```
🚕 [打车状态机] 导航状态切换为: 10 (到达接客终点)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🚗 车辆编号: 1
   ...
   🗺️  导航: 到达接客终点  ← 状态10（关键状态）
   ...
```

#### **回到默认状态1**

```
🚕 [打车状态机] 打车流程完成，回到默认状态: 1 (正常行驶)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🚗 车辆编号: 1
   ...
   🗺️  导航: 正常行驶(空载不入库)  ← 回到状态1
   ...
```

---

### **4. 验证前端行为**

在应用中观察：

1. **点击"呼叫出租车"后**：
   - ✅ UI上的起点终点立即清除
   - ✅ 沙盘上的起点终点图标立即消失
   - ✅ 显示Toast："出租车订单已发送给1号车"

2. **导航状态变化过程**（在浏览器控制台查看）：
   - 状态3（5秒）
   - 状态9（5秒）
   - 状态4（5秒）
   - **状态10（5秒）** ← 前端检测到此状态后，会打印：
     ```
     🎉 车辆 1 已到达接客终点，打车任务完成
     ```

3. **状态10后**：
   - ✅ 车辆从 `activeTaxiRides` Map 中删除
   - ✅ 打车流程完成

---

## 📊 时间线示例

假设在 `00:00` 时点击"呼叫出租车"：

| 时间 | 导航状态 | 前端行为 | 测试客户端日志 |
|------|---------|---------|--------------|
| 00:00 | 1 | 点击打车按钮，清除UI | - |
| 00:01 | 3 | - | "启动打车状态机，状态3" |
| 00:06 | 9 | - | "状态切换为9" |
| 00:11 | 4 | - | "状态切换为4" |
| **00:16** | **10** | **前端检测到10，打印"🎉 打车任务完成"** | **"状态切换为10"** |
| 00:21 | 1 | - | "打车流程完成，回到状态1" |

---

## 🔍 调试技巧

### **1. 查看当前打车状态**

在测试客户端中添加调试输出：

```python
# 在 update_taxi_state_machine() 中添加
print(f"[DEBUG] 状态机: active={taxi_state_machine['active']}, "
      f"current={taxi_state_machine['current_state']}, "
      f"elapsed={elapsed:.1f}s")
```

### **2. 修改状态持续时间**

如需加快测试，修改状态持续时间：

```python
taxi_state_machine = {
    # ...
    'state_duration': 3  # 改为3秒（原本5秒）
}
```

### **3. 查看前端 activeTaxiRides**

在浏览器控制台执行：

```javascript
// 获取carStore
const carStore = window.__vue_app__?.config?.globalProperties?.$pinia?.state?.value?.car;

// 查看活跃打车订单
console.log('活跃打车订单:', carStore?.activeTaxiRides);

// 检查车辆1是否在打车状态
console.log('车辆1在打车状态?', carStore?.isVehicleInTaxiMode(1));
```

---

## ⚠️ 注意事项

### **1. 多车辆测试**

如需测试多个车辆同时打车，启动多个测试客户端：

```bash
# 终端1
python3 test/test_client.py 1

# 终端2
python3 test/test_client.py 2
```

### **2. 平行驾驶优先级**

平行驾驶模式（状态15）优先级最高，会暂停打车状态机：

```python
if now_ms < force_parallel_until:
    nav_status = 15  # 平行驾驶优先
else:
    nav_status = update_taxi_state_machine()  # 打车状态机
```

### **3. 状态机重置**

如果需要手动重置状态机，在测试客户端中添加：

```python
def reset_taxi_state_machine():
    """重置打车状态机"""
    global taxi_state_machine
    taxi_state_machine['active'] = False
    taxi_state_machine['current_state'] = 1
    taxi_state_machine['state_index'] = 0
    print("🚕 [打车状态机] 已重置")
```

---

## 📝 测试检查清单

- [ ] 启动测试客户端后，导航状态默认为1
- [ ] 点击"呼叫出租车"后，UI立即清除起点终点
- [ ] 测试客户端收到0x1003协议
- [ ] 测试客户端打印"启动打车状态机"
- [ ] 导航状态按顺序变化：3 → 9 → 4 → 10
- [ ] 每个状态持续约5秒
- [ ] 状态10时，前端控制台打印"🎉 打车任务完成"
- [ ] 状态10后，回到状态1
- [ ] 可以再次打车，流程正常重复

---

## 🚀 快速测试命令

```bash
# 1. 启动应用（另一个终端）
cd /Users/plum/Workspace/rust/dz-viz
npm run tauri:dev

# 2. 启动测试客户端
python3 test/test_client.py 1

# 3. 在应用中进行打车操作，观察日志
```

---

## 📚 相关文档

| 文档 | 说明 |
|------|------|
| `TAXI_ORDER_TRACKING.md` | 打车功能完整文档 |
| `TAXI_ORDER_IMPLEMENTATION_SUMMARY.md` | 打车功能实现总结 |
| `test/test_client.py` | 测试客户端源码 |

---

**测试愉快！** 🎉

