# Socket通信协议规范

## 协议基本结构

所有消息都遵循统一的协议格式：

| 字段名称 | 字节长度 | 数据类型 | 说明 |
|---------|---------|---------|------|
| 帧头 | 4 | UINT32 | 固定值：0xEF 0xEF 0xEF 0xEF |
| 协议版本 | 1 | UINT8 | 0x10（高四位主版本号，低四位次版本号，当前为1.0版） |
| 时间戳 | 8 | UINT64 | 64位无符号整数，数据帧发送时间（毫秒） |
| 消息类型 | 2 | UINT16 | 消息类型标识（小端序） |
| 数据域长度 | 4 | UINT32 | 数据域字节数（小端序） |
| 数据域 | N | * | 实际数据，按消息类型解析 |
| CRC校验 | 2 | UINT16 | CRC16校验码（小端序） |
| 帧尾 | 4 | UINT32 | 固定值：0xFE 0xFE 0xFE 0xFE |

### CRC校验说明
- 校验范围：从第5个字节开始（即协议版本字节）到CRC字段之前的所有字节
- 校验算法：CRC16，多项式为 x^16 + x^12 + x^5 + 1
- 字节序：低字节在前，高字节在后

## 消息类型定义

### 接收消息类型（车辆 → 服务端）

| 消息类型 | 值 | 说明 |
|---------|---|------|
| HEARTBEAT | 0x0001 | 心跳包 |
| VEHICLE_INFO | 0x0002 | 车辆信息 |

### 发送消息类型（服务端 → 车辆）

| 消息类型 | 值 | 说明 |
|---------|---|------|
| VEHICLE_CONTROL | 0x1001 | 车辆控制指令 |
| DATA_RECORDING | 0x1002 | 数据记录控制 |
| TAXI_ORDER | 0x1003 | 出租车订单 |
| AVP_PARKING | 0x1004 | AVP自主代客泊车 |
| AVP_PICKUP | 0x1005 | AVP取车 |
| VEHICLE_FUNCTION_SETTING | 0x1006 | 车辆功能设置 |
| VEHICLE_PATH_DISPLAY | 0x1007 | 车辆路径显示控制 |

## 详细协议定义

### 1. 心跳协议（0x0001）

**方向：车辆 → 服务端**

**数据域：** 无（长度为0）

**发送频率：** 建议每10秒发送一次

**示例：**
```
帧头: EF EF EF EF
版本: 10
时间戳: [8字节时间戳]
消息类型: 01 00
数据长度: 00 00 00 00
数据域: [无]
CRC: [2字节CRC]
帧尾: FE FE FE FE
```

### 2. 车辆信息协议（0x0002）

**方向：车辆 → 服务端**

**数据域（38字节）：**

| 字段名称 | 字节偏移 | 字节长度 | 数据类型 | 说明 |
|---------|---------|---------|---------|------|
| 车辆编号 | 0 | 1 | UINT8 | 车辆唯一标识符 |
| 车速 | 1 | 8 | DOUBLE | 当前车速（m/s，范围0-1） |
| 位置X | 9 | 8 | DOUBLE | X坐标位置 |
| 位置Y | 17 | 8 | DOUBLE | Y坐标位置 |
| 电池电量 | 25 | 8 | DOUBLE | 电池电量百分比（0-100） |
| 导航状态 | 33 | 1 | UINT8 | 0:未导航；1:导航中 |
| 相机状态 | 34 | 1 | UINT8 | 0:异常；1:正常 |
| 激光雷达状态 | 35 | 1 | UINT8 | 0:异常；1:正常 |
| 陀螺仪状态 | 36 | 1 | UINT8 | 0:异常；1:正常 |
| 北斗状态 | 37 | 1 | UINT8 | 0:异常；1:正常 |

**发送频率：** 建议每2秒发送一次

**示例：**
```
帧头: EF EF EF EF
版本: 10
时间戳: [8字节时间戳]
消息类型: 02 00
数据长度: 26 00 00 00  (38字节)
数据域:
  车辆编号: 01
  车速: [8字节DOUBLE，小端序]
  位置X: [8字节DOUBLE，小端序]
  位置Y: [8字节DOUBLE，小端序]
  电池电量: [8字节DOUBLE，小端序]
  导航状态: 01
  相机状态: 01
  激光雷达状态: 01
  陀螺仪状态: 01
  北斗状态: 01
CRC: [2字节CRC]
帧尾: FE FE FE FE
```

### 3. 车辆控制指令协议（0x1001）

**方向：服务端 → 车辆**

**数据域（可变长度）：**

| 字段名称 | 字节偏移 | 字节长度 | 数据类型 | 说明 |
|---------|---------|---------|---------|------|
| 车辆编号 | 0 | 1 | UINT8 | 目标车辆编号 |
| 控制指令 | 1 | 1 | UINT8 | 控制指令类型 |
| 位置X | 2 | 8 | DOUBLE | X坐标（仅初始化位姿时存在） |
| 位置Y | 10 | 8 | DOUBLE | Y坐标（仅初始化位姿时存在） |
| 朝向 | 18 | 8 | DOUBLE | 朝向角度（仅初始化位姿时存在） |

**控制指令类型：**

| 指令名称 | 值 | 说明 | 数据域长度 |
|---------|---|------|----------|
| 启动车辆 | 1 | 启动车辆系统 | 2字节 |
| 停止车辆 | 2 | 停止车辆运行 | 2字节 |
| 紧急制动 | 3 | 立即停止并制动 | 2字节 |
| 切换空载模式 | 4 | 切换到空载运行模式 | 2字节 |
| 初始化位姿 | 5 | 设置车辆初始位置和朝向 | 26字节 |

**示例1 - 启动车辆：**
```
帧头: EF EF EF EF
版本: 10
时间戳: [8字节时间戳]
消息类型: 01 10
数据长度: 02 00 00 00  (2字节)
数据域:
  车辆编号: 01
  控制指令: 01  (启动车辆)
CRC: [2字节CRC]
帧尾: FE FE FE FE
```

**示例2 - 初始化位姿：**
```
帧头: EF EF EF EF
版本: 10
时间戳: [8字节时间戳]
消息类型: 01 10
数据长度: 1A 00 00 00  (26字节)
数据域:
  车辆编号: 01
  控制指令: 05  (初始化位姿)
  位置X: [8字节DOUBLE，小端序]
  位置Y: [8字节DOUBLE，小端序]
  朝向: [8字节DOUBLE，小端序]
CRC: [2字节CRC]
帧尾: FE FE FE FE
```

### 4. 数据记录控制协议（0x1002）

**方向：服务端 → 车辆**

**数据域（2字节）：**

| 字段名称 | 字节偏移 | 字节长度 | 数据类型 | 说明 |
|---------|---------|---------|---------|------|
| 车辆编号 | 0 | 1 | UINT8 | 目标车辆编号 |
| 记录数据 | 1 | 1 | UINT8 | 0:关闭；1:开启 |

**记录状态定义：**

| 状态名称 | 值 | 说明 |
|---------|---|------|
| 关闭记录 | 0 | 停止数据记录 |
| 开启记录 | 1 | 开始数据记录 |

**示例 - 开启数据记录：**
```
帧头: EF EF EF EF
版本: 10
时间戳: [8字节时间戳]
消息类型: 02 10
数据长度: 02 00 00 00  (2字节)
数据域:
  车辆编号: 01
  记录数据: 01  (开启)
CRC: [2字节CRC]
帧尾: FE FE FE FE
```

**示例 - 关闭数据记录：**
```
帧头: EF EF EF EF
版本: 10
时间戳: [8字节时间戳]
消息类型: 02 10
数据长度: 02 00 00 00  (2字节)
数据域:
  车辆编号: 01
  记录数据: 00  (关闭)
CRC: [2字节CRC]
帧尾: FE FE FE FE
```

### 5. 出租车订单协议（0x1003）

**方向：服务端 → 车辆（广播）**

**数据域（48字节）：**

| 字段名称 | 字节偏移 | 字节长度 | 数据类型 | 说明 |
|---------|---------|---------|---------|------|
| 订单号 | 0 | 16 | CHAR16 | 16字节UUID字符串（不足用空字节填充） |
| 起点X | 16 | 8 | DOUBLE | 起点X坐标 |
| 起点Y | 24 | 8 | DOUBLE | 起点Y坐标 |
| 终点X | 32 | 8 | DOUBLE | 终点X坐标 |
| 终点Y | 40 | 8 | DOUBLE | 终点Y坐标 |

**发送方式：** 广播给所有在线车辆

**数据库记录：** 发送成功后自动保存到数据库，包含订单信息和接单车辆ID字段（待接单后更新）

**示例 - 出租车订单：**
```
帧头: EF EF EF EF
版本: 10
时间戳: [8字节时间戳]
消息类型: 03 10
数据长度: 30 00 00 00  (48字节)
数据域:
  订单号: "ABC123DEF456GHI0" (16字节，不足用0填充)
  起点X: [8字节DOUBLE，小端序] (116.4)
  起点Y: [8字节DOUBLE，小端序] (39.9)
  终点X: [8字节DOUBLE，小端序] (118.5)
  终点Y: [8字节DOUBLE，小端序] (41.2)
CRC: [2字节CRC]
帧尾: FE FE FE FE
```

**处理逻辑：**
1. 检查在线车辆数量，如果为0则返回"当前没有可用车辆"
2. 生成16字符的订单UUID
3. 构建48字节数据域（坐标使用默认值）
4. 广播消息给所有在线车辆
5. 发送成功后保存订单信息到SQLite数据库
6. 返回发送结果和成功车辆数量

### 6. AVP自主代客泊车协议（0x1004）

**方向：服务端 → 车辆（单播）**

**数据域（2字节）：**

| 字段名称 | 字节偏移 | 字节长度 | 数据类型 | 说明 |
|---------|---------|---------|---------|------|
| 车辆编号 | 0 | 1 | UINT8 | 目标车辆的编号 |
| 停车位编号 | 1 | 1 | UINT8 | 指定的停车位编号（当前写死为1） |

**发送方式：** 单播给指定车辆（车辆在线检查）

**数据库记录：** 发送成功后自动保存到`avp_parking`表，包含车辆ID和停车位编号

**示例 - AVP泊车指令：**
```
帧头: EF EF EF EF
版本: 10
时间戳: [8字节时间戳]
消息类型: 04 10
数据长度: 02 00 00 00  (2字节)
数据域:
  车辆编号: 01
  停车位编号: 01  (1号车位)
CRC: [2字节CRC]
帧尾: FE FE FE FE
```

**处理逻辑：**
1. 检查选中的车辆是否存在
2. 检查车辆是否在线，如果离线则返回"选中的车辆当前离线"
3. 构建2字节数据域（车辆编号 + 停车位编号）
4. 发送消息给指定车辆
5. 发送成功后保存泊车记录到SQLite数据库
6. 返回发送结果

**前端行为：**
- 泊车车辆下拉框从SQLite数据库读取车辆信息
- 显示车辆名称，不带额外描述
- 离线车辆显示警告Toast："选中的车辆当前离线，无法执行泊车操作"
- 发送成功显示成功Toast："AVP泊车指令发送成功，车辆正在执行泊车"

### 7. AVP取车协议（0x1005）

**方向：服务端 → 车辆（单播）**

**数据域（1字节）：**

| 字段名称 | 字节偏移 | 字节长度 | 数据类型 | 说明 |
|---------|---------|---------|---------|------|
| 车辆编号 | 0 | 1 | UINT8 | 目标车辆的编号 |

**发送方式：** 单播给指定车辆（车辆在线检查）

**数据库记录：** 发送成功后自动保存到`avp_pickup`表，包含车辆ID和创建时间

**示例 - AVP取车指令：**
```
帧头: EF EF EF EF
版本: 10
时间戳: [8字节时间戳]
消息类型: 05 10
数据长度: 01 00 00 00  (1字节)
数据域:
  车辆编号: 01
CRC: [2字节CRC]
帧尾: FE FE FE FE
```

**处理逻辑：**
1. 检查选中的车辆是否存在
2. 检查车辆是否在线，如果离线则返回"选中的车辆当前离线"
3. 构建1字节数据域（车辆编号）
4. 发送消息给指定车辆
5. 发送成功后保存取车记录到SQLite数据库
6. 返回发送结果

**前端行为：**
- 取车车辆下拉框从SQLite数据库读取车辆信息
- 显示车辆名称，不带额外描述
- 离线车辆显示警告Toast："选中的车辆当前离线，无法执行取车操作"
- 发送成功显示成功Toast："AVP取车指令发送成功，车辆正在执行取车"

---

## 8. 车辆功能设置协议（0x1006）

### 8.1 数据域结构
```
数据域内容       字节长度    数据类型    内容说明
车辆编号         1           UINT8       车辆的编号
功能编号         1           UINT8       功能模块编号
启用状态         1           UINT8       功能启用状态
```

### 8.2 功能编号定义
| 编号 | 功能名称     | 说明                           |
|------|-------------|--------------------------------|
| 0    | 全部        | 所有程序（批量操作）            |
| 1    | 传感器      | 传感器模块                     |
| 2    | 建图        | 建图功能模块                   |
| 3    | 录制        | 录制功能模块                   |
| 4    | 定位        | 定位功能模块                   |
| 5    | 自主导航    | 自主导航功能模块               |
| 6    | 图像识别    | 图像识别功能模块               |
| 7    | 打靶功能    | 打靶功能模块                   |

### 8.3 启用状态定义
| 状态值 | 说明   |
|--------|--------|
| 0      | 关闭   |
| 1      | 启用   |

### 8.4 协议示例
#### 示例1：启用车辆1的传感器功能
```
帧头: EF EF EF EF
协议版本: 10
时间戳: 当前时间戳
消息类型: 10 06 (0x1006)
数据域长度: 03 00 00 00 (3字节)
数据域: 01 01 01 (车辆1, 传感器, 启用)
CRC: [2字节校验码]
帧尾: FE FE FE FE
```

#### 示例2：关闭车辆2的所有程序
```
帧头: EF EF EF EF
协议版本: 10
时间戳: 当前时间戳
消息类型: 10 06 (0x1006)
数据域长度: 03 00 00 00 (3字节)
数据域: 02 00 00 (车辆2, 全部, 关闭)
CRC: [2字节校验码]
帧尾: FE FE FE FE
```

### 8.5 处理逻辑
1. **发送条件：** 功能设置页面中选择车辆并点击功能按钮时触发
2. **目标检查：** 发送前检查目标车辆是否在线
3. **批量操作：** 当功能编号为0时，影响车辆的所有功能模块
4. **状态同步：** 发送成功后更新前端UI状态

## 9. 车辆路径显示控制协议（0x1007）

### 9.1 数据域结构
```
数据域内容       字节长度    数据类型    内容说明
车辆编号         1           UINT8       车辆的编号
显示路径         1           UINT8       路径发送控制状态
```

### 9.2 显示路径状态定义
| 状态值 | 说明               |
|--------|-------------------|
| 0      | 车端不发送路径数据  |
| 1      | 车端开启发送路径数据 |

### 9.3 协议示例
#### 示例1：开启车辆1的路径数据发送
```
帧头: EF EF EF EF
协议版本: 10
时间戳: 当前时间戳
消息类型: 10 07 (0x1007)
数据域长度: 02 00 00 00 (2字节)
数据域: 01 01 (车辆1, 开启发送)
CRC: [2字节校验码]
帧尾: FE FE FE FE
```

#### 示例2：关闭车辆2的路径数据发送
```
帧头: EF EF EF EF
协议版本: 10
时间戳: 当前时间戳
消息类型: 10 07 (0x1007)
数据域长度: 02 00 00 00 (2字节)
数据域: 02 00 (车辆2, 停止发送)
CRC: [2字节校验码]
帧尾: FE FE FE FE
```

### 9.4 处理逻辑
1. **发送条件：** 功能设置页面中选择车辆并点击"查看车辆路径"按钮时触发
2. **目标检查：** 发送前检查目标车辆是否在线
3. **路径控制：** 车辆收到指令后控制是否向服务端发送路径轨迹数据
4. **实时反馈：** 发送成功后显示Toast提示消息

---
