# 倒计时UV映射问题分析和解决方案

## 📋 问题现象

1. **倒计时数字完全看不清**：显示模糊或只能看到部分像素
2. **数字不更新**：看起来像静态的混乱图案
3. **与Sprite方案不同**：Sprite方案能显示，但Canvas纹理方案不行

## 🔍 问题根源：UV映射

### 什么是UV映射？

UV映射是3D模型表面和2D纹理图片之间的对应关系：
- **U坐标**：纹理的水平方向（0 = 左边，1 = 右边）
- **V坐标**：纹理的垂直方向（0 = 下边，1 = 上边）
- 每个3D模型的顶点都有一个UV坐标，指示该点应该使用纹理图片的哪个位置

### 当前问题

倒计时对象（`MD_HongLvDeng_WenZi`）的UV坐标可能：
1. **覆盖范围太小**：比如只使用纹理的5%区域 → 数字在UV范围之外
2. **UV坐标错位**：指向纹理的边角而不是中心 → 数字位置不对
3. **UV拉伸严重**：UV比例不对 → 数字变形或模糊

## 🧪 UV调试步骤

### 1. 重启应用（开启UV调试模式）
```bash
npm run tauri dev
python3 test/sandbox_client.py
```

### 2. 观察倒计时区域

现在Canvas上绘制了UV调试图案：
- **洋红色边框**：Canvas的外边界
- **绿色十字线**：Canvas的中心点
- **白色数字**：实际倒计时数字（在中心附近）

**根据你看到的图案判断问题：**

#### 情况A：完全看不到任何颜色
→ **UV范围极小**或**UV指向纹理外**
- 问题：模型的UV坐标几乎为0或全部相同
- 严重程度：⚠️⚠️⚠️ 严重

#### 情况B：只能看到一小块纯色（洋红或绿色的一点）
→ **UV覆盖范围<10%**
- 问题：UV展开不完整，只映射了纹理的一小块
- 严重程度：⚠️⚠️ 中等

#### 情况C：能看到边框或十字线，但很拉伸/变形
→ **UV比例不对**
- 问题：UV宽高比与模型不匹配
- 严重程度：⚠️ 较轻

#### 情况D：能看到完整的边框和十字线
→ **UV正常，问题在别处**
- 可能：数字位置、大小、颜色问题
- 严重程度：无（UV没问题）

### 3. 在浏览器控制台运行UV检查脚本

复制粘贴 `scripts/check_countdown_uv.js` 的内容到控制台，会输出：
- UV坐标范围（如：U: [0.0, 1.0], V: [0.0, 1.0]）
- UV覆盖百分比（如：100% x 100% 或 5% x 5%）
- UV问题诊断

**复制输出结果，发给建模工程师**

## 📝 给建模工程师的说明

### 模型信息
- **模型文件**：`sandbox.glb`
- **问题对象**：`MD_HongLvDeng_WenZi`（及其实例：`MD_HongLvDeng_WenZi_(1)` ~ `MD_HongLvDeng_WenZi_(7)`）
- **共8个实例**

### 纹理要求
- **纹理尺寸**：512 x 512 像素
- **内容布局**：
  - 黑色背景
  - 中心区域（约200x180像素）：白色数字
  - 单个数字：约在 X=316, Y=256 位置
  - 两个数字：约在 X=150-200 和 X=312-360，Y=256

### UV坐标要求

#### 最低要求（必须满足）
- UV坐标必须覆盖**至少30%**的纹理空间
- 推荐：覆盖至少50%

#### 理想状态
- UV坐标完全展开，覆盖 [0, 0] 到 [1, 1] 的完整纹理空间
- UV中心点在 (0.5, 0.5)

#### 可接受范围
- UV范围：U [0.2, 0.8]，V [0.2, 0.8]
- 或更大

### 如何在Blender中修复UV

#### 方案1：自动UV展开（推荐，最简单）
```
1. 选择倒计时对象（MD_HongLvDeng_WenZi）
2. 进入编辑模式（Tab键）
3. 选择所有顶点（A键）
4. UV菜单 → Smart UV Project
   - 或：UV菜单 → Unwrap
5. 在UV编辑器中：
   - 选择所有UV点（A键）
   - 缩放到完整的[0,1]范围（S键，然后输入适当的缩放值）
   - 确保UV居中（可以使用 UV → Align Auto）
```

#### 方案2：手动调整UV
```
1. 进入UV编辑模式
2. 选择所有UV点
3. 查看当前UV范围
4. 使用S（缩放）、G（移动）调整UV：
   - 确保UV覆盖大部分纹理空间
   - UV中心应该在纹理中心（0.5, 0.5）
```

#### 方案3：重置UV
```
1. 选择对象
2. 删除现有UV：Object Data Properties → UV Maps → 删除
3. 重新创建：添加新的UV Map
4. 使用方案1重新展开
```

### 验证UV修复

修复后，在Blender中验证：
1. UV编辑器中，UV应该覆盖大部分格子（至少50%）
2. 材质预览模式下，应用一个测试纹理（如棋盘格）
3. 确保纹理正确显示在倒计时表面

### 批量处理8个实例

如果8个倒计时对象共享相同的Mesh数据：
- 只需修复一个，其他会自动更新

如果它们是独立的：
- 可以：选择所有8个对象 → 一起进入编辑模式 → 一起修复UV
- 或：修复一个后，复制UV数据到其他对象

## 🔧 临时解决方案（如果不能修改模型）

如果无法立即修改模型，可以：

### 选项1：使用Sprite方案
- 性能稍差，但不依赖UV
- 已经实现，可以切换回去

### 选项2：调整Canvas绘制区域
- 如果UV只覆盖纹理的某个角落，可以调整数字绘制位置
- 需要先用UV检查脚本确定UV实际范围
- 然后修改代码，让数字绘制在UV范围内

## 📞 需要提供给建模工程师的信息

1. **UV检查脚本的输出结果**（重要！）
2. **UV调试模式的截图**：
   - 倒计时区域显示什么（洋红边框、绿十字线等）
3. **问题现象截图**：
   - 当前倒计时显示效果
4. **本文档**（作为参考）

## 🎯 修复后的验证

建模工程师修复并导出新模型后：

1. **替换模型文件**：用新的 `sandbox.glb` 替换旧文件
2. **关闭UV调试模式**：
   ```javascript
   // trafficLightManager.js 第52行
   const UV_DEBUG_MODE = false;  // 改为 false
   ```
3. **重启应用验证**：
   ```bash
   npm run tauri dev
   python3 test/sandbox_client.py
   ```
4. **预期效果**：
   - 倒计时区域：纯黑色背景
   - 数字：清晰的白色数字
   - 更新：数字实时变化

---

## ❓ 常见问题

### Q: 为什么Sprite方案能显示，Canvas方案不行？
A: Sprite是独立的2D面板，不依赖模型的UV。Canvas纹理需要通过UV映射到模型表面，如果UV有问题就会显示异常。

### Q: 能不能程序里自动修复UV？
A: 不能。UV坐标是模型数据的一部分，无法在运行时修改。必须在Blender等建模软件中修复并重新导出。

### Q: UV问题会影响其他部分吗？
A: 不会。只影响倒计时对象的纹理显示。红绿灯本身（红、黄、绿灯）使用的是材质颜色，不依赖UV。

### Q: 修复UV需要多久？
A: 对于熟悉Blender的工程师，5-10分钟即可完成。如果不熟悉，可能需要30分钟到1小时。

### Q: 如果建模工程师不可用怎么办？
A: 暂时使用Sprite方案。虽然性能稍差，但功能完全正常。

---

**创建日期**：2025-10-25
**适用版本**：dz-viz v1.0

