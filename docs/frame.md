# UDP视频流协议文档

## 协议概述

本协议用于通过UDP传输JPEG格式的视频帧数据，支持大帧的分片传输以适应网络MTU限制。

## 协议版本

当前版本：`1`

## 数据包结构

每个UDP数据包由包头和数据两部分组成：

```
[包头 26字节] + [JPEG数据 N字节]
```

## 包头格式

包头固定26字节，结构如下：

| 偏移量 | 长度 | 字段名 | 类型 | 说明 |
|--------|------|--------|------|------|
| 0 | 1 | version | u8 | 协议版本号（当前为1） |
| 1 | 1 | frame_type | u8 | 帧类型（见下表） |
| 2 | 4 | vehicle_id | u32 | 车辆ID（大端序） |
| 6 | 4 | frame_id | u32 | 帧序列号（大端序） |
| 10 | 2 | fragment_index | u16 | 分片索引，从0开始（大端序） |
| 12 | 2 | total_fragments | u16 | 总分片数（大端序） |
| 14 | 8 | timestamp | u64 | 时间戳（毫秒，大端序） |
| 22 | 4 | data_length | u32 | 当前分片数据长度（大端序） |

## 帧类型

| 值 | 名称 | 说明 |
|----|------|------|
| 0x01 | Complete | 完整帧（未分片） |
| 0x02 | FragmentFirst | 分片帧的第一片 |
| 0x03 | FragmentMiddle | 分片帧的中间片 |
| 0x04 | FragmentLast | 分片帧的最后一片 |

## 传输逻辑

### 小帧传输（完整帧）

对于小于MTU限制的JPEG帧：
1. 设置`frame_type = 0x01`（Complete）
2. 设置`fragment_index = 0`
3. 设置`total_fragments = 1`
4. 直接传输整个JPEG数据

### 大帧传输（分片）

对于大于MTU限制的JPEG帧：
1. 将JPEG数据分割成多个片段
2. 第一片：`frame_type = 0x02`（FragmentFirst）
3. 中间片：`frame_type = 0x03`（FragmentMiddle）
4. 最后片：`frame_type = 0x04`（FragmentLast）
5. 所有分片使用相同的`frame_id`和`vehicle_id`
6. `fragment_index`从0开始递增
7. `total_fragments`为总分片数

## 接收端处理

1. 解析UDP包头，验证协议版本
2. 根据`frame_type`判断处理方式：
   - Complete：直接使用JPEG数据
   - Fragment*：缓存分片并等待重组
3. 对于分片帧：
   - 使用`(vehicle_id, frame_id)`作为键缓存分片
   - 收集到所有分片后按`fragment_index`顺序重组
   - 超时未完成的分片自动清理

## 示例数据包

### 完整帧示例

```
版本: 01
帧类型: 01 (Complete)
车辆ID: 00 00 00 7B (123)
帧ID: 00 00 01 C8 (456)
分片索引: 00 00 (0)
总分片数: 00 01 (1)
时间戳: 00 00 00 00 49 96 02 D2 (1234567890)
数据长度: 00 00 04 00 (1024)
[JPEG数据 1024字节]
```

### 分片帧示例

第一片：
```
版本: 01
帧类型: 02 (FragmentFirst)
车辆ID: 00 00 00 7B (123)
帧ID: 00 00 01 C9 (457)
分片索引: 00 00 (0)
总分片数: 00 03 (3)
时间戳: 00 00 00 00 49 96 02 D3 (1234567891)
数据长度: 00 00 05 DC (1500)
[JPEG数据第一部分 1500字节]
```

中间片：
```
版本: 01
帧类型: 03 (FragmentMiddle)
车辆ID: 00 00 00 7B (123)
帧ID: 00 00 01 C9 (457)
分片索引: 00 01 (1)
总分片数: 00 03 (3)
时间戳: 00 00 00 00 49 96 02 D3 (1234567891)
数据长度: 00 00 05 DC (1500)
[JPEG数据中间部分 1500字节]
```

最后片：
```
版本: 01
帧类型: 04 (FragmentLast)
车辆ID: 00 00 00 7B (123)
帧ID: 00 00 01 C9 (457)
分片索引: 00 02 (2)
总分片数: 00 03 (3)
时间戳: 00 00 00 00 49 96 02 D3 (1234567891)
数据长度: 00 00 02 00 (512)
[JPEG数据最后部分 512字节]
```

## 错误处理

1. **协议版本不匹配**：丢弃数据包
2. **包头长度不足**：丢弃数据包
3. **数据长度不匹配**：丢弃数据包
4. **分片超时**：清理未完成的重组器（默认5秒）
5. **重复分片**：后收到的覆盖之前的

## 性能优化建议

1. **MTU设置**：建议分片大小不超过1400字节（考虑UDP和IP头部开销）
2. **JPEG质量**：建议使用70-80的质量设置平衡文件大小和画质
3. **帧率控制**：根据网络带宽调整发送帧率
4. **缓冲区管理**：接收端及时清理超时的重组器

## 扩展性

协议设计预留了扩展空间：
- 版本号支持未来协议升级
- 时间戳字段支持帧同步和延迟测量
- 车辆ID支持多车辆场景
- 帧类型可扩展支持其他编码格式
