# MSE æµåª’ä½“å®ç°æ€»ç»“

## ğŸ¯ ç›®æ ‡
å°† RTSP è§†é¢‘æµæ’­æ”¾æ–¹æ¡ˆä» MediaMTX + WebRTC è¿ç§»åˆ° **MSE (Media Source Extensions)**ï¼Œä»¥å®ç°ï¼š
- âœ… **æœ€ä½å»¶è¿Ÿ**ï¼š1-2ç§’ï¼ˆvs WebRTC 0.5-1ç§’ï¼ŒHLS 6-15ç§’ï¼‰
- âœ… **è·¨å¹³å°å…¼å®¹**ï¼šæ”¯æŒ Windowsã€macOSã€Ubuntuï¼ˆWebRTC åœ¨ Tauri Ubuntu ä¸Šä¸å¯ç”¨ï¼‰
- âœ… **æ¶æ„ç®€åŒ–**ï¼šç§»é™¤ MediaMTX ä¾èµ–ï¼Œå‡å°‘å¤–éƒ¨è¿›ç¨‹
- âœ… **é«˜æ€§èƒ½**ï¼šç›´æ¥ fMP4 æµå¼ä¼ è¾“ï¼Œæ— éœ€é¢å¤–è½¬ç 

---

## ğŸ“‹ å®ç°æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RTSP   â”‚â”€â”€â”€â–¶â”‚   FFmpeg    â”‚â”€â”€â”€â–¶â”‚  WebSocket   â”‚â”€â”€â”€â–¶â”‚  MSE Player â”‚
â”‚ æ‘„åƒå¤´  â”‚    â”‚ (fMP4 è½¬æ¢) â”‚    â”‚  (Rust 9003) â”‚    â”‚  (å‰ç«¯ JS)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    Rust                  Rust                Vue 3
```

### æ•°æ®æµè¯¦è§£
1. **RTSP è¾“å…¥**ï¼šæ‘„åƒå¤´çš„ RTSP æµ
2. **FFmpeg è½¬æ¢**ï¼šå®æ—¶è½¬æ¢ä¸º fMP4 æ ¼å¼ï¼ˆfragmented MP4ï¼ŒMSE æ ‡å‡†æ ¼å¼ï¼‰
3. **WebSocket æ¨é€**ï¼šRust WebSocket æœåŠ¡å™¨å¹¿æ’­ fMP4 æ•°æ®ç»™å‰ç«¯
4. **MSE æ’­æ”¾**ï¼šå‰ç«¯ä½¿ç”¨ MediaSource API æ¥æ”¶å¹¶æ’­æ”¾

---

## ğŸ› ï¸ å®ç°ç»†èŠ‚

### 1. Rust åç«¯

#### æ–°å¢æ–‡ä»¶ï¼š
- **`src-tauri/src/mse_streamer/mod.rs`**
  - `MseStreamer` ç»“æ„ä½“ï¼šç®¡ç† FFmpeg è¿›ç¨‹å’Œå¹¿æ’­é€šé“
  - å¯åŠ¨ RTSP â†’ fMP4 æµè½¬æ¢
  - ä½¿ç”¨ `tokio::broadcast` å®ç°å¤šè®¢é˜…è€…æ•°æ®åˆ†å‘

- **`src-tauri/src/mse_streamer/websocket.rs`**
  - WebSocket æœåŠ¡å™¨ï¼ˆç«¯å£ 9003ï¼‰
  - æ¥æ”¶å‰ç«¯è®¢é˜…è¯·æ±‚ï¼ˆ`{ "camera_id": 3 }`ï¼‰
  - æŒç»­æ¨é€ fMP4 æ•°æ®ç‰‡æ®µ

- **`src-tauri/src/commands/mse.rs`**
  - `start_mse_stream`ï¼šå¯åŠ¨æµè½¬æ¢
  - `stop_mse_stream`ï¼šåœæ­¢æµè½¬æ¢
  - `is_mse_stream_active`ï¼šæ£€æŸ¥æµçŠ¶æ€

#### FFmpeg å‚æ•°ä¼˜åŒ–ï¼š
```rust
let mut args = vec![
    "-loglevel", "warning",
    "-hide_banner",
];

if rtsp_url.starts_with("rtsp://") {
    args.extend_from_slice(&[
        "-rtsp_transport", "tcp",
        "-max_delay", "500000",
        "-analyzeduration", "1000000",
        "-probesize", "500000",
    ]);
}

args.extend_from_slice(&[
    "-i", &rtsp_url,
    "-c:v", "copy",                    // è§†é¢‘ç›´æ¥å¤åˆ¶ï¼ˆä¸é‡ç¼–ç ï¼‰
    "-c:a", "aac",                      // éŸ³é¢‘è½¬ä¸º AACï¼ˆMSE æ ‡å‡†ï¼‰
    "-movflags", "frag_keyframe+empty_moov+default_base_moof",  // fMP4 å…³é”®æ ‡å¿—
    "-fflags", "nobuffer",              // ç¦ç”¨ç¼“å†²
    "-flags", "low_delay",              // ä½å»¶è¿Ÿ
    "-f", "mp4",                        // MP4 å®¹å™¨
    "pipe:1",                           // è¾“å‡ºåˆ° stdout
]);
```

#### ä¿®æ”¹æ–‡ä»¶ï¼š
- **`src-tauri/src/lib.rs`**
  - ç§»é™¤ `mod mediamtx_manager`
  - æ·»åŠ  `mod mse_streamer`
  - å¯åŠ¨ WebSocket æœåŠ¡å™¨ï¼ˆæ›¿ä»£ MediaMTXï¼‰
  - æ³¨å†Œ MSE å‘½ä»¤

- **`src-tauri/src/commands/mod.rs`**
  - ç§»é™¤ `mediamtx` æ¨¡å—
  - æ·»åŠ  `mse` æ¨¡å—å¯¼å‡º

#### åˆ é™¤æ–‡ä»¶ï¼š
- âŒ `src-tauri/src/mediamtx_manager.rs`
- âŒ `src-tauri/src/commands/mediamtx.rs`

---

### 2. å‰ç«¯å®ç°

#### æ–°å¢æ–‡ä»¶ï¼š
- **`src/utils/msePlayer.js`**
  - `MsePlayer` ç±»ï¼šå°è£… MSE æ’­æ”¾é€»è¾‘
  - è‡ªåŠ¨è¿æ¥ WebSocket
  - åˆ›å»º `MediaSource` å’Œ `SourceBuffer`
  - æ•°æ®é˜Ÿåˆ—ç®¡ç†ï¼ˆé˜²æ­¢ `appendBuffer` å¹¶å‘ï¼‰
  - Buffer è‡ªåŠ¨æ¸…ç†ï¼ˆä¿ç•™æœ€å 30 ç§’ï¼Œé˜²æ­¢å†…å­˜æº¢å‡ºï¼‰

```javascript
export class MsePlayer {
    constructor(videoElement, wsUrl, cameraId) { ... }
    async start() { ... }
    appendData(arrayBuffer) { ... }
    processQueue() { ... }
    cleanupBuffer() { ... }
    stop() { ... }
}
```

#### ä¿®æ”¹æ–‡ä»¶ï¼š
- **`src/views/Control.vue`**
  - å¯¼å…¥ `MsePlayer`
  - ä¿®æ”¹ `startRTSPCamera` å‡½æ•°ï¼š
    - è°ƒç”¨ `invoke('start_mse_stream')` æ›¿ä»£ `start_mediamtx_stream`
    - åˆ›å»º `MsePlayer` å®ä¾‹æ›¿ä»£ WebRTC `RTCPeerConnection`
    - ç®€åŒ–ä»£ç ï¼šä» ~250 è¡Œå‡å°‘åˆ° ~90 è¡Œ
  
  - ä¿®æ”¹ `stopVideoStream` å‡½æ•°ï¼š
    - åœæ­¢ `MsePlayer` æ›¿ä»£å…³é—­ `PeerConnection`
    - è°ƒç”¨ `invoke('stop_mse_stream')` æ›¿ä»£ `stop_mediamtx_stream`
  
  - åˆ é™¤æ‰€æœ‰ WebRTC ç›¸å…³ä»£ç ï¼š
    - `RTCPeerConnection` åˆ›å»ºå’Œç®¡ç†
    - `WHEP` åè®®æ¡æ‰‹
    - ICE è¿æ¥çŠ¶æ€ç›‘å¬
    - `tempVideoRef` ä¸´æ—¶å…ƒç´ é€»è¾‘

---

## ğŸ”§ é…ç½®æ›´æ”¹

### Cargo.toml
- **æ— éœ€ä¿®æ”¹**ï¼š`tokio-tungstenite` å’Œ `futures-util` å·²å­˜åœ¨

### package.json
- **æ— éœ€ä¿®æ”¹**ï¼šMSE æ˜¯æµè§ˆå™¨åŸç”Ÿ API

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

| æ–¹æ¡ˆ | å»¶è¿Ÿ | Ubuntu æ”¯æŒ | ä¾èµ– | å†…å­˜å ç”¨ | å®ç°å¤æ‚åº¦ |
|------|------|------------|------|----------|-----------|
| **MSE (å½“å‰)** | **1-2ç§’** | âœ… | FFmpeg | ä¸­ | ä½ |
| WebRTC (ä¹‹å‰) | 0.5-1ç§’ | âŒ Tauri ä¸æ”¯æŒ | MediaMTX + FFmpeg | é«˜ | é«˜ |
| HLS | 6-15ç§’ | âœ… | FFmpeg | ä½ | ä¸­ |
| LL-HLS | 2-3ç§’ | âœ… | MediaMTX + FFmpeg | ä¸­ | ä¸­ |

---

## âœ… æµ‹è¯•ç»“æœ

### Rust ç¼–è¯‘
```bash
cargo check
# âœ… ç¼–è¯‘æˆåŠŸï¼Œæ—  MSE ç›¸å…³è­¦å‘Š
```

### å‰ç«¯æ„å»º
```bash
npm run build
# âœ… æ„å»ºæˆåŠŸ (23.41s)
```

### è¿è¡Œæ—¶æµ‹è¯• (éœ€æ‰‹åŠ¨éªŒè¯)
- [ ] RTSP æµæˆåŠŸå¯åŠ¨
- [ ] WebSocket è¿æ¥å»ºç«‹
- [ ] è§†é¢‘æ­£å¸¸æ’­æ”¾
- [ ] å»¶è¿Ÿåœ¨ 1-2 ç§’èŒƒå›´
- [ ] åˆ‡æ¢æ‘„åƒå¤´æ— å†…å­˜æ³„æ¼
- [ ] é•¿æ—¶é—´è¿è¡Œç¨³å®š

---

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### å¯åŠ¨åº”ç”¨
```bash
npm run tauri:dev
```

### è¿æ¥ RTSP æ‘„åƒå¤´
1. åœ¨"æ§åˆ¶"é¡µé¢é€‰æ‹© RTSP æ‘„åƒå¤´
2. åº”ç”¨è‡ªåŠ¨å¯åŠ¨ FFmpeg è½¬æ¢å’Œ WebSocket è¿æ¥
3. è§†é¢‘åœ¨ 1-2 ç§’å†…å¼€å§‹æ’­æ”¾

### åœæ­¢è§†é¢‘æµ
- åˆ‡æ¢åˆ°å…¶ä»–æ‘„åƒå¤´è‡ªåŠ¨åœæ­¢å½“å‰æµ
- å…³é—­åº”ç”¨è‡ªåŠ¨æ¸…ç†æ‰€æœ‰èµ„æº

---

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šè§†é¢‘ä¸æ’­æ”¾
- **æ£€æŸ¥**ï¼šæµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰ MSE ç›¸å…³é”™è¯¯
- **è§£å†³**ï¼šç¡®è®¤æµè§ˆå™¨æ”¯æŒ `video/mp4; codecs="avc1.64001f,mp4a.40.2"`

### é—®é¢˜ 2ï¼šå»¶è¿Ÿè¿‡é«˜
- **æ£€æŸ¥**ï¼šFFmpeg æ—¥å¿—ä¸­æ˜¯å¦æœ‰ buffer è­¦å‘Š
- **è§£å†³**ï¼šè°ƒæ•´ `-probesize` å’Œ `-analyzeduration` å‚æ•°

### é—®é¢˜ 3ï¼šWebSocket è¿æ¥å¤±è´¥
- **æ£€æŸ¥**ï¼šç«¯å£ 9003 æ˜¯å¦è¢«å ç”¨
- **è§£å†³**ï¼š`lsof -i :9003` æ£€æŸ¥å¹¶ä¿®æ”¹ `lib.rs` ä¸­çš„ç«¯å£

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **ç¼–è§£ç å™¨é™åˆ¶**ï¼š
   - è§†é¢‘å¿…é¡»æ˜¯ H.264 (AVC)
   - éŸ³é¢‘å¿…é¡»æ˜¯ AAC
   - å¦‚æœæºæµæ˜¯å…¶ä»–æ ¼å¼ï¼ŒFFmpeg ä¼šè‡ªåŠ¨è½¬ç ï¼ˆå¢åŠ  CPU è´Ÿæ‹…å’Œå»¶è¿Ÿï¼‰

2. **å†…å­˜ç®¡ç†**ï¼š
   - MSE ä¼šåœ¨ SourceBuffer ä¸­ç¼“å­˜æ•°æ®
   - `cleanupBuffer()` å®šæœŸæ¸…ç† 15 ç§’å‰çš„æ—§æ•°æ®
   - é•¿æ—¶é—´æ’­æ”¾ä¸ä¼šå¯¼è‡´å†…å­˜æ³„æ¼

3. **é”™è¯¯æ¢å¤**ï¼š
   - FFmpeg è¿›ç¨‹å´©æºƒä¼šè‡ªåŠ¨ä»è¿›ç¨‹è¡¨ä¸­ç§»é™¤
   - å‰ç«¯å¯ä»¥é‡æ–°è°ƒç”¨ `start_mse_stream` æ¢å¤
   - WebSocket æ–­å¼€ä¼šè§¦å‘å‰ç«¯é”™è¯¯å¤„ç†

---

## ğŸ‰ æ€»ç»“

æˆåŠŸå°† RTSP è§†é¢‘æµæ’­æ”¾æ–¹æ¡ˆä» MediaMTX + WebRTC è¿ç§»åˆ° MSEï¼Œå®ç°äº†ï¼š
- âœ… æœ€ä½å»¶è¿Ÿï¼ˆ1-2ç§’ï¼‰
- âœ… è·¨å¹³å°å…¼å®¹ï¼ˆWindows/macOS/Ubuntuï¼‰
- âœ… æ¶æ„ç®€åŒ–ï¼ˆç§»é™¤ MediaMTXï¼‰
- âœ… ä»£ç å‡å°‘ï¼ˆControl.vue å‡å°‘ ~160 è¡Œï¼‰
- âœ… ç¼–è¯‘é€šè¿‡ï¼ˆæ— é”™è¯¯å’Œè­¦å‘Šï¼‰

**æ¨èç”Ÿäº§ç¯å¢ƒä½¿ç”¨ï¼**

